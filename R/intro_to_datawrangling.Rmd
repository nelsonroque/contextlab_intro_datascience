---
title: "Introduction to Data Wrangling & Visualization in R"
author: "Nelson Roque"
date: "9/24/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Overview

The goals of this workshop include:
  - Learn about data wrangling principles (e.g., tidy data)
  - Import, pre-process & visualize data using R
  - Share recommended readings, activities for continued learning

[Click Here for Workshop Slides](https://ucf-my.sharepoint.com/:p:/g/personal/ne612914_ucf_edu/EfT1stHIoLtLtGBJM0ke1gEBQUf_px34eSKH4GMtNIgIBg?e=gfgN2L)

## Intro to R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

Note that `echo = FALSE`, when added to the code chunk, prevents printing of the R code that generated the output.

## Load libs/packages

```{r}

library(readr)
library(tidyverse)

```

## Read in data

"These Community Mobility Reports aim to provide insights into what has changed in response to policies aimed at combating COVID-19. The reports chart movement trends over time by geography, across different categories of places such as retail and recreation, groceries and pharmacies, parks, transit stations, workplaces, and residential."

[Learn More](https://www.google.com/covid19/mobility/)

```{r}
# read in the Google Mobility dataset
google_mobility <- read_csv("https://www.gstatic.com/covid19/mobility/Global_Mobility_Report.csv")

#google_mobility_byregion = "https://www.gstatic.com/covid19/mobility/Region_Mobility_Report_CSVs.zip"

```

## Create lookup tables

R, as well as some packages, have built in datasets. They can be called with the data() function (e.g., data(state)). We will leverage a built in dataset with state metadata.

```{r}
data(state)
state_lookup = tibble(sub_region_1 = state.name,
                      us_division = state.division,
                      us_region = state.region,
                      state_land_area = state.area)
```

## Pre-process data
 
```{r}

# >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

# filter for US
google_mobility_US <- google_mobility %>%
  filter(country_region == "United States") %>%
  mutate(dt_date = date) %>%
  mutate(dt_month = lubridate::month(dt_date),
         dt_month_ = lubridate::month(dt_date, label=T),
         dt_year= lubridate::year(dt_date),
         dt_day = lubridate::day(dt_date),
         dt_wkday_l = lubridate::wday(dt_date, label=T),
         dt_wkday_n = lubridate::wday(dt_date)) %>%
  mutate(dt_weekend = ifelse(dt_wkday_l %in% c("Sat", "Sun"), TRUE, FALSE))

```

## Joining datasets

```{r}
google_mobility_US_w_lu <- google_mobility_US %>%
  inner_join(state_lookup)
```
## Quick descriptives

```{r}

#skimr::skim(google_mobility_US)

```

## Filter data
```{r}

# filter with specific entries
google_mobility_US_NY <- google_mobility_US %>%
  filter(sub_region_1 == "New York")

google_mobility_US_FL <- google_mobility_US %>%
  filter(sub_region_1 == "Florida")

# >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

# filter to a 'vector' of entries
google_mobility_US_targeted <- google_mobility_US %>%
  filter(sub_region_1 %in% c("California", "New York", "Florida"))

```

## Compute aggregates

```{r}

# base R approach
table(google_mobility_US$sub_region_1)

# number of records by state
records_per_state = google_mobility_US %>%
  group_by(sub_region_1) %>%
  summarise(n_records = n()) %>%
  arrange(sub_region_1)
records_per_state

```

```{r}

# >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

# group data by weekday
metrics_month_weekend_US <- google_mobility_US %>%
  group_by(sub_region_1, dt_year, dt_month_, dt_wkday_l) %>%
  summarise(avg_change_parks = mean(parks_percent_change_from_baseline, na.rm=T),
            avg_change_retail_rec = mean(retail_and_recreation_percent_change_from_baseline, na.rm=T),
            avg_change_workplaces = mean(workplaces_percent_change_from_baseline, na.rm=T)) %>%
  inner_join(state_lookup)
```

## Visualize the data

```{r}

# plot summary data across all states
allUS_retail = ggplot(metrics_month_weekend_US %>% filter(us_region %in% c("South", "West")), aes(sub_region_1, avg_change_retail_rec)) +
  geom_boxplot() +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=90)) +
  facet_wrap(dt_year~.) +
  labs(x="Month", y="Retail (% Change)")

allUS_parks = ggplot(metrics_month_weekend_US %>% filter(us_region %in% c("South", "West")), aes(sub_region_1, avg_change_parks)) +
  geom_boxplot() +
  theme_minimal() +
  facet_wrap(dt_year~.) +
  theme(axis.text.x=element_text(angle=90)) +
  labs(x="Month", y="Parks (% Change)")

allUS_retail
allUS_parks
```

```{r}
jitter_retail <- ggplot(metrics_month_weekend_US, aes(dt_month_, 
                                     avg_change_retail_rec, 
                                     group=us_region,
                                     color=us_region)) +
  #geom_point() +
  geom_jitter() +
  theme_minimal() +
  labs(x="Month", y="Retail & Recreation (% Change)")

smooth_retail = ggplot(metrics_month_weekend_US, aes(dt_month_, 
                                     avg_change_retail_rec, 
                                     group=us_region,
                                     color=us_region)) +
  #geom_point() +
  #geom_jitter() +
  geom_smooth() +
  theme_minimal() +
  labs(x="Month", y="Retail & Recreation (% Change)")

smooth_parks = ggplot(metrics_month_weekend_US, aes(dt_month_, 
                                     avg_change_parks, 
                                     group=us_region,
                                     color=us_region)) +
  #geom_point() +
  #geom_jitter() +
  geom_smooth() +
  theme_minimal() +
  labs(x="Month", y="Parks (% Change)")

jitter_retail
smooth_retail
smooth_parks
```

# Combining multiple plots
```{r}
library(cowplot)

# create a plot of weekly trends
early_covid_retail = ggplot(google_mobility_US_targeted %>%
         filter(dt_month %in% c(1,2,3,4,5)) %>%
         filter(dt_year == 2020), aes(dt_date, 
                                    retail_and_recreation_percent_change_from_baseline,
                                    color=sub_region_1)) +
  #geom_point() +
  geom_jitter() +
  theme_minimal() +
  facet_wrap(.~sub_region_1) +
  labs(x="Month", y="Retal & Rec (% Change)", title="2020")

early_covid_parks = ggplot(google_mobility_US_targeted %>%
         filter(dt_month %in% c(1,2,3,4,5)) %>%
         filter(dt_year == 2020), aes(dt_date, 
                                    parks_percent_change_from_baseline,
                                    color=sub_region_1)) +
  #geom_point() +
  geom_jitter() +
  theme_minimal() +
  facet_wrap(.~sub_region_1) +
  labs(x="Month", y="Parks (% Change)", title="2020")

nxtyear_covid_retail = ggplot(google_mobility_US_targeted %>%
         filter(dt_month %in% c(1,2,3,4,5)) %>%
         filter(dt_year == 2021), aes(dt_date, 
                                    retail_and_recreation_percent_change_from_baseline,
                                    color=sub_region_1)) +
  #geom_point() +
  geom_jitter() +
  theme_minimal() +
  facet_wrap(.~sub_region_1) +
  labs(x="Month", y="Retal & Rec (% Change)", title="2021")

```

```{r}
cowplot::plot_grid(early_covid_retail, early_covid_parks, ncol=1)
cowplot::plot_grid(early_covid_retail, nxtyear_covid_retail, ncol=1)
cowplot::plot_grid(allUS_retail, allUS_parks, ncol=1)
cowplot::plot_grid(smooth_retail, smooth_parks, ncol=1)
```

## Filter dataset for next plots
```{r}
# Variable names -----
#   retail_and_recreation_percent_change_from_baseline = col_double(),
#   grocery_and_pharmacy_percent_change_from_baseline = col_double(),
#   parks_percent_change_from_baseline = col_double(),
#   transit_stations_percent_change_from_baseline = col_double(),
#   workplaces_percent_change_from_baseline = col_double(),
#   residential_percent_change_from_baseline = col_double()


early_covid_period_data = google_mobility_US_w_lu %>%
         filter(dt_month %in% c(1,2,3,4,5,6)) %>%
         filter(dt_year == 2020) %>%
         filter(sub_region_1 %in% c("New York", "California", "Florida", "Wyoming", "Texas", "Arizona","Montana", "South Dakota", "Nevada"))

```

## Styling your plots (theme_*)

```{r}
ggplot(early_covid_period_data, aes(dt_date, 
                                    parks_percent_change_from_baseline,
                                    color=sub_region_1)) +
  #geom_point() +
  theme_void() +
  geom_jitter() +
  facet_wrap(.~sub_region_1) +
  theme(legend.position = "none")

ggplot(early_covid_period_data, aes(dt_date, 
                                    parks_percent_change_from_baseline,
                                    color=sub_region_1)) +
  geom_jitter() +
  facet_wrap(.~sub_region_1)

ggplot(early_covid_period_data, aes(dt_date, 
                                    parks_percent_change_from_baseline,
                                    color=sub_region_1)) +
  #geom_point() +
  theme_bw() +
  geom_jitter() +
  facet_wrap(.~sub_region_1)

ggplot(early_covid_period_data, aes(dt_date, 
                                    parks_percent_change_from_baseline,
                                    color=sub_region_1)) +
  #geom_point() +
  theme_dark() +
  geom_jitter() +
  facet_wrap(.~sub_region_1)
```

# Production plot

```{r}
ggplot(early_covid_period_data, aes(dt_date, 
                                    parks_percent_change_from_baseline,
                                    color=us_region)) +
  #geom_point() +
  theme_bw() +
  geom_jitter() +
  facet_wrap(.~sub_region_1) +
  labs(x= "Date", y="Retail & Recreation (% Change)")
```

```{r}
ggplot(early_covid_period_data, aes(dt_date, 
                                    parks_percent_change_from_baseline,
                                    color=us_region)) +
  #geom_point() +
  geom_jitter() +
  facet_wrap(.~sub_region_1) +
  labs(x= "Date", y="Retail & Recreation (% Change)") +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle=90))
```

```{r}
fig1 <- ggplot(early_covid_period_data, aes(dt_date, 
                                    retail_and_recreation_percent_change_from_baseline,
                                    color=us_region)) +
  #geom_point() +
  #geom_jitter() +
  geom_smooth() +
  facet_wrap(.~sub_region_1) +
  labs(x= "Date", y="Retail & Recreation (% Change)",
       #color="State",
       tag = "Figure 1",
       title = "Google Mobility: Change over Time",
       subtitle = "i.e., Retail & Recreation, early COVID-19 period (01/20 - 06/20)",
       caption = "Google Mobility: Retail & Recreation (% Change) over early COVID period (01/20 - 06/20)") +
  theme_bw(base_size = 12, base_family = "Arial")

fig2 <- ggplot(early_covid_period_data, aes(dt_date, 
                                    parks_percent_change_from_baseline,
                                    color=us_region)) +
  #geom_point() +
  #geom_jitter() +
  geom_smooth() +
  facet_wrap(.~sub_region_1) +
  labs(x= "Date", y="Retail & Recreation (% Change)",
       #color="State",
       tag = "Figure 2",
       title = "Google Mobility: Change over Time",
       subtitle = "i.e., Parks, early COVID-19 period (01/20 - 06/20)",
       caption = "Google Mobility: Parks (% Change) over early COVID period (01/20 - 06/20)") +
  theme_bw(base_size = 12, base_family = "Arial")
fig1
fig2
```

```{r}

largest_changes_parks_long <- google_mobility_US %>%
  group_by(sub_region_1, dt_year) %>%
  summarise(avg_change_parks = mean(parks_percent_change_from_baseline, na.rm=T)) %>%
  arrange(sub_region_1)

largest_changes_parks_wide <- largest_changes_parks_long %>%
  #pivot_wider(id_cols=c())
  pivot_wider(names_from = dt_year, values_from = avg_change_parks) %>%
  mutate(change_2021_2020 = `2021` - `2020`)

top10_changes <- largest_changes_parks_wide %>%
  arrange(-change_2021_2020) %>%
  head(n=10)

bottom10_changes <- largest_changes_parks_wide %>%
  arrange(change_2021_2020) %>%
  head(n=10)

largest_changes_parks_long
largest_changes_parks_wide

top10_changes
bottom10_changes
```

## Download cheatsheets on using various R packages
  - [R Markdown](https://github.com/rstudio/cheatsheets/raw/master/rmarkdown.pdf)
  - [Data Wrangling Cheatsheet](https://www.rstudio.com/wp-content/uploads/2015/02/data-wrangling-cheatsheet.pdf)
  - [Data Transformation with dplyr](https://github.com/rstudio/cheatsheets/raw/master/data-visualization.pdf)
  - [Data Import](https://github.com/rstudio/cheatsheets/raw/master/data-import.pdf)
  - [String Manipulation](https://github.com/rstudio/cheatsheets/raw/master/strings.pdf)
  - [Work with dates/times](https://github.com/rstudio/cheatsheets/raw/master/lubridate.pdf)
  - [More cheatsheets](https://www.rstudio.com/resources/cheatsheets/)
