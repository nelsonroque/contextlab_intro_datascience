---
title: "Intro to Data Wrangling - R"
author: "Nelson Roque"
date: "9/20/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Intro to R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

Note that `echo = FALSE`, when added to the code chunk, prevents printing of the R code that generated the output.

## Load libs/packages

```{r}

library(readr)
library(tidyverse)

```

## Read in data

"These Community Mobility Reports aim to provide insights into what has changed in response to policies aimed at combating COVID-19. The reports chart movement trends over time by geography, across different categories of places such as retail and recreation, groceries and pharmacies, parks, transit stations, workplaces, and residential."

[Learn More](https://www.google.com/covid19/mobility/)

```{r}
# read in the Google Mobility dataset
google_mobility <- read_csv("https://www.gstatic.com/covid19/mobility/Global_Mobility_Report.csv")

#google_mobility_byregion = "https://www.gstatic.com/covid19/mobility/Region_Mobility_Report_CSVs.zip"

```

## Pre-process data
 
```{r}

# >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

# filter for US
google_mobility_US <- google_mobility %>%
  filter(country_region == "United States") %>%
  mutate(dt_date = date) %>%
  mutate(dt_month = lubridate::month(dt_date),
         dt_year= lubridate::year(dt_date),
         dt_day = lubridate::day(dt_date),
         dt_wkday_l = lubridate::wday(dt_date, label=T),
         dt_wkday_n = lubridate::wday(dt_date))

```

# Get simple descriptives
```{r}

# >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

table(google_mobility_US$sub_region_1)
table(google_mobility_US$sub_region_2)

# count number of missing data records for this specific column
table(is.na(google_mobility_US$sub_region_2))

# get proportion of missing data records for this specific column
prop.table(table(is.na(google_mobility_US$sub_region_1)))
prop.table(table(is.na(google_mobility_US$sub_region_2)))

# get proportion of null records for this specific column
prop.table(table(is.null(google_mobility_US$sub_region_2)))

```
## Quick descriptives

```{r}

skimr::glance(google_mobility_US)

```

## Filter data
```{r}
# >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

# filter with specific entries
google_mobility_US_NY <- google_mobility_US %>%
  filter(sub_region_1 == "New York")

google_mobility_US_FL <- google_mobility_US %>%
  filter(sub_region_1 == "Florida")


# filter to a 'vector' of entries
google_mobility_US_targeted <- google_mobility_US %>%
  filter(sub_region_1 %in% c("California", "New York", "Florida"))

```

## Compute aggregates

```{r}

# >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

# group data by weekday
metrics_month_day_of_week <- google_mobility_US_targeted %>%
  group_by(sub_region_1, dt_year, dt_month, dt_wkday_l) %>%
  summarise(avg_change_parks = mean(parks_percent_change_from_baseline, na.rm=T),
            avg_change_retail_rec = mean(retail_and_recreation_percent_change_from_baseline, na.rm=T),
            avg_change_workplaces = mean(workplaces_percent_change_from_baseline, na.rm=T))

# TODO: replicate above, with month
# TODO: replicate above, with month, year

```

## Visualize the data

```{r}

# plot grouped month data
ggplot(metrics_month_day_of_week, aes(dt_month, avg_change_retail_rec)) +
  #geom_point() +
  geom_jitter() +
  theme_minimal() +
  facet_wrap(dt_year~.)


ggplot(metrics_month_day_of_week, aes(dt_month, avg_change_retail_rec)) +
  #geom_point() +
  geom_jitter() +
  theme_minimal() +
  facet_wrap(sub_region_1 ~ dt_year, ncol = 2)

```

```{r}
ggplot(metrics_month_day_of_week, aes(dt_month, avg_change_workplaces)) +
  #geom_point() +
  geom_jitter() +
  theme_minimal() +
  facet_wrap(sub_region_1 ~ dt_year, ncol = 2)

```

# Styling your plots
```{r}

```


# Combining multiple plots
```{r}
library(cowplot)

# create a plot of weekly trends
ggplot(google_mobility_US_targeted %>%
         filter(dt_month == 3), aes(dt_date, 
                                    retail_and_recreation_percent_change_from_baseline,
                                    color=sub_region_1)) +
  #geom_point() +
  geom_jitter() +
  theme_minimal() +
  facet_wrap(dt_year~sub_region_1)
  
# create a plot of monthly trends


# retail_and_recreation_percent_change_from_baseline = col_double(),
#   grocery_and_pharmacy_percent_change_from_baseline = col_double(),
#   parks_percent_change_from_baseline = col_double(),
#   transit_stations_percent_change_from_baseline = col_double(),
#   workplaces_percent_change_from_baseline = col_double(),
#   residential_percent_change_from_baseline = col_double()

```

## Download cheatsheets on using various R packages
[R Markdown](https://github.com/rstudio/cheatsheets/raw/master/rmarkdown.pdf)
[Data Wrangling Cheatsheet](https://www.rstudio.com/wp-content/uploads/2015/02/data-wrangling-cheatsheet.pdf)
[Data Transformation with dplyr](https://github.com/rstudio/cheatsheets/raw/master/data-visualization.pdf)
[Data Import](https://github.com/rstudio/cheatsheets/raw/master/data-import.pdf)
[String Manipulation](https://github.com/rstudio/cheatsheets/raw/master/strings.pdf)
[Work with dates/times](https://github.com/rstudio/cheatsheets/raw/master/lubridate.pdf)
[More cheatsheets](https://www.rstudio.com/resources/cheatsheets/)

